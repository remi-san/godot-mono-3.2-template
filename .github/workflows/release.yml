name: "Release"
on:
  push:
    tags:
      - 'v*'

env:
  GAME_SUBDIRECTORY: game
  GODOT_VERSION: 3.2.3
  GODOT_VERSION_MODIFIER: stable.mono
  EXPORT_NAME: "Template"

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version-without-v }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          lfs: true
      - name: Get version name
        id: get_version
        uses: battila7/get-version-action@v2
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          release_name: Release ${{ steps.get_version.outputs.version-without-v }}
          body: ""
          draft: false
          prerelease: false

  export:
    name: Export
    runs-on: ubuntu-latest
    needs: release
    strategy:
      matrix:
        platform: [ windows, mac, linux, html ]
    container:
      image: barichello/godot-ci:mono-3.2.3
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          lfs: true
      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/templates
          mv /root/.local/share/godot/templates/${GODOT_VERSION}.${GODOT_VERSION_MODIFIER} ~/.local/share/godot/templates/${GODOT_VERSION}.${GODOT_VERSION_MODIFIER}
      - name: Define file name
        id: export_file
        env:
          EXPORT_PLATFORM: ${{ matrix.platform }}
        run: |
          if   [ "${EXPORT_PLATFORM}" = "windows" ]
          then
              echo "::set-output name=filename::${EXPORT_NAME}.exe"
              echo "::set-output name=type::executable"
          elif [ "${EXPORT_PLATFORM}" = "mac" ]
          then
              echo "::set-output name=filename::${EXPORT_NAME}.zip"
              echo "::set-output name=type::archive"
          elif [ "${EXPORT_PLATFORM}" = "linux" ]
          then
              echo "::set-output name=filename::${EXPORT_NAME}.x86_64"
              echo "::set-output name=type::executable"
          elif [ "${EXPORT_PLATFORM}" = "html" ]
          then
              echo "::set-output name=filename::index.html"
              echo "::set-output name=type::executable"
          fi
      - name: Build
        id: build
        env:
          EXPORT_PLATFORM: ${{ matrix.platform }}
          EXPORT_FILENAME: ${{ steps.export_file.outputs.filename }}
        run: |
          buildPath="${GITHUB_WORKSPACE}/build/${EXPORT_PLATFORM}"
          filePath="${buildPath}/${EXPORT_FILENAME}"
          mkdir -v -p "${buildPath}"
          godot -v --path "./$GAME_SUBDIRECTORY" --export "${EXPORT_PLATFORM}" "${filePath}"
          echo "::set-output name=build_directory::${buildPath}"
          echo "::set-output name=build_file::${filePath}"
      - name: Archive
        id: archive
        env:
          EXPORT_PLATFORM: ${{ matrix.platform }}
          BUILD_DIRECTORY: ${{ steps.build.outputs.build_directory }}
          BUILD_FILE: ${{ steps.build.outputs.build_file }}
          FILE_TYPE: ${{ steps.export_file.outputs.type }}
          VERSION: ${{ needs.release.outputs.version }}
        run: |
          rootBuildPath="${GITHUB_WORKSPACE}/build"
          formattedExportName="$( echo ${EXPORT_NAME} | sed 's/./\L&/g' | sed 's/ /-/g' )"
          filename="${formattedExportName}-${EXPORT_PLATFORM}-v${VERSION}.zip"
          filePath="${rootBuildPath}/${filename}"
          if [ "${FILE_TYPE}" = "executable" ]
          then
              cd "${BUILD_DIRECTORY}" && zip -r "${filePath}" *
          else
              mv "${BUILD_FILE}" "${filePath}"
          fi
          echo "::set-output name=path::${filePath}"
          echo "::set-output name=filename::${filename}"
      - name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.release.outputs.release_upload_url }}
          asset_path: ${{ steps.archive.outputs.path }}
          asset_name: ${{ steps.archive.outputs.filename }}
          asset_content_type: application/zip
